- name: make apt not installing 'Suggests' and 'Recommends' by default
  file:
    src: /opt/admintools/etc/apt/apt.conf.d/99MinimalInstalls
    dest: /etc/apt/apt.conf.d/99MinimalInstalls
    state: link

- name: disable apt (systemd) timers
  systemd:
    name: "{{ item }}"
    enabled: false
  with_items:
    - apt-daily.timer
    - apt-daily-upgrade.timer

- name: create configuration file to set release priorities
  blockinfile:
    dest: /etc/apt/preferences.d/000-release-pinning
    create: yes
    insertbefore: BOF
    marker: "# {mark} ANSIBLE MANAGED README BLOCK"
    block: |
      # Managed by Ansible (lpirl/ansible-roles, role "managed_host").
      # Do not edit this file, it will likely result in odd behavior.
      # Instead, create a separate file in this directory or use the
      # role's variable ``apt_release_priorities_extra``.

  when: apt_release_priorities
        | combine(apt_release_priorities_extra
                  | default({}))

- name: configure apt repositories for standard releases (stable, testing, â€¦)
  include_tasks: _apt-config-configure-standard-release.yml

  vars:
    base_url: http://deb.debian.org
    suite: "{{ item.key }}"
    release: "{{ suite.split('-').0.split('/').0 }}"
    pin_priority: "{{ item.value }}"
    file: "/etc/apt/sources.list.d/{{ release }}.list"
    state: "{{ 'present' if item.value else 'absent' }}"

  with_dict: "{{
    apt_release_priorities
    | combine(apt_release_priorities_extra
              | default({}))
  }}"

  loop_control:
    label: "{{ item.key }}"

- name: flush handlers in case apt cache needs to be updated
  meta: flush_handlers

- name: get contents of /etc/apt/sources.list
  register: cat_sources_list_result
  shell: cat /etc/apt/sources.list
  changed_when: false
  failed_when: false
  tags: [report]

- name: notify root of empty /etc/apt/sources.list via email
  mail:
    subject: consider deleting apparently empty file
             /etc/apt/sources.list
    body: |
      Contents:
      """
      {{ cat_sources_list_result.stdout }}
      """
      EOM
  when: not cat_sources_list_result.stdout
            | regex_findall('^(?!\s*#).*$', multiline=True)
  tags: [report]
