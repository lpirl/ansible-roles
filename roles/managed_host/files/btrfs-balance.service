[Unit]
Description=start balance all btrfs file systems
ConditionCapability=CAP_SYS_ADMIN
ConditionCapability=CAP_SYS_RAWIO

[Service]
Type=exec
KillMode=none
ExecStart=/bin/sh -c '\
  grep btrfs /proc/mounts \
  | cut -d" " -f2 \
  | xargs -L1 \
    btrfs balance start \
'
ExecStop=/bin/sh -c '\
  grep btrfs /proc/mounts \
  | cut -d" " -f2 \
  | xargs -L1 -IX sh -c " \
    btrfs balance cancel \"X\"; \
    [ $? -eq 0 ] || [ $? -eq 2 ] \
  " \
'
IOSchedulingClass=idle
Nice=19
